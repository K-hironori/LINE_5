name: Deploy to Xserver

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install FTP tools
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp
        echo "lftp version:"
        lftp --version
    
    - name: Verify file content
      run: |
        echo "=== Verifying index.html ==="
        ls -la index.html
        echo "=== Checking for 'hiro' in file ==="
        grep -n "hiro" index.html || echo "No 'hiro' found"
        echo "=== File size ==="
        wc -c index.html
    
    - name: Deploy to Xserver using lftp
      run: |
        echo "=== Starting deployment with lftp ==="
        
        # Create lftp script
        cat > deploy.lftp << EOF
        set ftp:ssl-allow no
        set ftp:ssl-force no
        set ftp:passive-mode on
        set net:timeout 60
        set net:max-retries 3
        set net:reconnect-interval-base 5
        open ftp://xs842747:${{ secrets.FTP_PASSWORD }}@sv16565.xserver.jp
        cd public_html
        put index.html
        ls -la index.html
        quit
        EOF
        
        echo "=== lftp script created ==="
        cat deploy.lftp | sed 's/:.*@/:***@/g'  # Hide password in logs
        
        echo "=== Executing lftp ==="
        lftp -f deploy.lftp
        
        if [ $? -eq 0 ]; then
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Site updated at: https://hironoristudio.com/"
        else
          echo "âŒ Deployment failed"
          exit 1
        fi
        
        # Clean up
        rm -f deploy.lftp
    
    - name: Verify deployment
      run: |
        echo "=== Verifying deployment ==="
        sleep 10
        curl -s https://hironoristudio.com/ | grep -o "hiro" | head -1 && echo "âœ… Site contains 'hiro'" || echo "âš ï¸ Site verification inconclusive"