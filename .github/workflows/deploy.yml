name: Deploy to Xserver

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug - Check file exists
      run: |
        echo "=== File check ==="
        ls -la index.html
        echo "=== File content preview ==="
        head -20 index.html | grep -E "(logo|hiro|©)"
        echo "=== Environment check ==="
        echo "Secret length: ${#FTP_PASSWORD}"
        echo "=== Network test ==="
        ping -c 3 sv16565.xserver.jp || echo "Ping failed, continuing..."
      env:
        FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
    
    - name: Deploy to Xserver via FTP with verbose logging
      run: |
        echo "=== Starting FTP upload ==="
        curl -T index.html \
             ftp://sv16565.xserver.jp/public_html/ \
             --user xs842747:${{ secrets.FTP_PASSWORD }} \
             --ftp-create-dirs \
             --connect-timeout 30 \
             --max-time 300 \
             --retry 3 \
             --retry-delay 10 \
             --verbose \
             --show-error \
             --fail
        
        upload_result=$?
        echo "=== Upload result: $upload_result ==="
        
        if [ $upload_result -eq 0 ]; then
          echo "✅ Upload successful!"
        else
          echo "❌ Upload failed with exit code: $upload_result"
          exit 1
        fi