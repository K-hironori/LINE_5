name: Deploy to Xserver

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Debug - Check file exists
      run: |
        echo "=== File check ==="
        ls -la index.html
        echo "=== File content preview ==="
        head -20 index.html | grep -E "(logo|hiro|©)"
        echo "=== Environment check ==="
        echo "Secret length: ${#FTP_PASSWORD}"
        echo "=== Network test ==="
        ping -c 3 sv16565.xserver.jp || echo "Ping failed, continuing..."
      env:
        FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
    
    - name: Deploy to Xserver via FTP with passive mode
      run: |
        echo "=== Starting FTP upload ==="
        curl -T index.html \
             ftp://sv16565.xserver.jp/public_html/ \
             --user xs842747:${{ secrets.FTP_PASSWORD }} \
             --ftp-pasv \
             --ftp-create-dirs \
             --connect-timeout 60 \
             --max-time 600 \
             --retry 5 \
             --retry-delay 15 \
             --verbose \
             --show-error \
             --insecure
        
        upload_result=$?
        echo "=== Upload result: $upload_result ==="
        
        if [ $upload_result -eq 0 ]; then
          echo "✅ Upload successful!"
          echo "Site should be updated at: https://hironoristudio.com/"
        else
          echo "❌ Upload failed with exit code: $upload_result"
          echo "Trying alternative approach..."
          
          # Alternative: Try without SSL/TLS
          curl -T index.html \
               ftp://sv16565.xserver.jp:21/public_html/ \
               --user xs842747:${{ secrets.FTP_PASSWORD }} \
               --ftp-pasv \
               --ftp-create-dirs \
               --connect-timeout 60 \
               --max-time 600 \
               --verbose
               
          alternative_result=$?
          if [ $alternative_result -eq 0 ]; then
            echo "✅ Alternative upload successful!"
          else
            echo "❌ Both upload methods failed"
            exit 1
          fi
        fi